  <!DOCTYPE html>
  <html dir="rtl" lang="ar">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>المتصدرون - مسابقة رمضان</title>
      <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
      <style>
          body {
              font-family: 'Arial', sans-serif;
              margin: 0;
              padding: 20px;
              background-color: #f0f0f0;
              text-align: center;
          }
          .container {
              max-width: 600px;
              margin: 0 auto;
              background-color: white;
              padding: 20px;
              border-radius: 10px;
              box-shadow: 0 0 10px rgba(0,0,0,0.1);
          }
          .leaderboard-item {
              margin: 10px 0;
              padding: 15px;
              background-color: #f8f8f8;
              border-radius: 5px;
              transition: all 0.3s ease;
          }
          .error-message {
              color: red;
              padding: 10px;
              margin: 10px 0;
              background-color: #ffe6e6;
              border-radius: 5px;
          }
          .create-index-message {
              background-color: #fff3cd;
              border: 1px solid #ffeeba;
              color: #856404;
              padding: 15px;
              margin: 10px 0;
              border-radius: 5px;
          }
          .create-index-button {
              background-color: #ffc107;
              color: #000;
              padding: 10px 20px;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              margin: 10px;
              text-decoration: none;
              display: inline-block;
          }
          button {
              background-color: #4CAF50;
              color: white;
              padding: 10px 20px;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              margin: 10px;
          }
          .gold { background-color: #FFD700; }
          .silver { background-color: #C0C0C0; }
          .bronze { background-color: #CD7F32; }
      </style>
  </head>
  <body>
      <div class="container">
          <h1>المتصدرون</h1>
          <div id="status"></div>
          <div id="leaderboard"></div>
          <button onclick="fetchScores()">تحديث النتائج</button>
          <a href="index.html"><button>العودة للمسابقة</button></a>
      </div>

      <script>
          const firebaseConfig = {
              apiKey: "AIzaSyC5RYK1lGaJaMQJmOH85cqNgv6m7rbLS_A",
              authDomain: "ramadanmotaz-5570f.firebaseapp.com",
              projectId: "ramadanmotaz-5570f",
              storageBucket: "ramadanmotaz-5570f.firebasestorage.app",
              messagingSenderId: "595667154066",
              appId: "1:595667154066:web:80ba616566ec55a5efe24b",
              measurementId: "G-WLVRQVRGHT"
          };

          let db;
          try {
              firebase.initializeApp(firebaseConfig);
              db = firebase.firestore();
          } catch (error) {
              console.error('Firebase initialization error:', error);
              document.getElementById('status').innerHTML = 
                  `<div class="error-message">خطأ في تهيئة قاعدة البيانات: ${error.message}</div>`;
          }

          async function fetchScores() {
              const statusDiv = document.getElementById('status');
              const leaderboardDiv = document.getElementById('leaderboard');
              
              statusDiv.innerHTML = 'جاري تحميل النتائج...';
              
              try {
                  // محاولة جلب النتائج بترتيب بسيط أولاً
                  const snapshot = await db.collection('scores')
                      .orderBy('score', 'desc')
                      .limit(10)
                      .get();

                  if (snapshot.empty) {
                      statusDiv.innerHTML = 'لا توجد نتائج بعد';
                      leaderboardDiv.innerHTML = '';
                      return;
                  }

                  let html = '';
                  let rank = 1;

                  snapshot.forEach(doc => {
                      const data = doc.data();
                      const className = rank === 1 ? 'gold' : 
                                      rank === 2 ? 'silver' : 
                                      rank === 3 ? 'bronze' : '';
                      
                      html += `
                          <div class="leaderboard-item ${className}">
                              #${rank} - ${data.playerName}<br>
                              النقاط: ${data.score}<br>
                              الوقت: ${data.totalTime ? data.totalTime.toFixed(2) : 'N/A'} ثانية
                          </div>
                      `;
                      rank++;
                  });

                  statusDiv.innerHTML = '';
                  leaderboardDiv.innerHTML = html;

              } catch (error) {
                  console.error('Error fetching scores:', error);
                  
                  if (error.message.includes('requires an index')) {
                      statusDiv.innerHTML = `
                          <div class="create-index-message">
                              <p>يحتاج النظام إلى إنشاء فهرس خاص في Firebase. يرجى اتباع الخطوات التالية:</p>
                              <ol style="text-align: right">
                                  <li>انقر على الزر أدناه للانتقال إلى لوحة تحكم Firebase</li>
                                  <li>قم بتسجيل الدخول إذا لزم الأمر</li>
                                  <li>انقر على "Create Index" في الصفحة التي ستفتح</li>
                                  <li>انتظر حتى يتم إنشاء الفهرس (قد يستغرق بضع دقائق)</li>
                                  <li>عد إلى هذه الصفحة وانقر على "تحديث النتائج"</li>
                              </ol>
                              <a class="create-index-button" href="https://console.firebase.google.com/v1/r/project/ramadanmotaz-5570f/firestore/indexes?create_composite=ClFwcm9qZWN0cy9yYW1hZGFubW90YXotNTU3MGYvZGF0YWJhc2VzLyhkZWZhdWx0KS9jb2xsZWN0aW9uR3JvdXBzL3Njb3Jlcy9pbmRleGVzL18QARoJCgVzY29yZRACGg0KCXRvdGFsVGltZRABGgwKCF9fbmFtZV9fEAE" target="_blank">
                                  إنشاء الفهرس في Firebase
                              </a>
                          </div>
                      `;
                  } else {
                      statusDiv.innerHTML = `
                          <div class="error-message">
                              حدث خطأ في تحميل النتائج: ${error.message}
                          </div>
                      `;
                  }
              }
          }

          // تحميل النتائج عند فتح الصفحة
          fetchScores();

          // تحديث النتائج كل 30 ثانية
          setInterval(fetchScores, 30000);
      </script>
  </body>
  </html>
